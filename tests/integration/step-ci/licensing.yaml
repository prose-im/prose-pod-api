version: "1.1"
name: Licensing
config:
  http:
    baseURL: ${{ env.host }}
env:
  $ref: "env.yaml#/env"

# NOTE: Paths are relative to the directory from which `stepci` is ran.
before:
  name: "Before all (not a test)"
  steps:
    - $ref: "init.yaml#/components/steps/log_admin_in"

tests:
  setLicense:
    name: Set license
    steps:
      - name: Set valid license
        http:
          method: PUT
          url: /v1/licensing/license
          auth:
            bearer:
              token: ${{ captures.token }}
          headers:
            Content-Type: text/plain
          # NOTE: Testing license with user limit at 20.
          body: EoYCCpkBCgRuYW1lChVUZXN0aW5nICh0ZXN0LmxvY2FsLikKCnVzZXJfbGltaXQKC3Rlc3QubG9jYWwuCgdhbGxvd2VkGAYiCgoICIAIEgMYgQgiCQoHCIIIEgIQFCINCgsIBBICGBQSAxiDCDIwCi4KAggbEgYIFBICCBQSCwgEEgIYFBIDCIQIGhMKBAoCCBQKBQoDCIQICgQaAggVEiQIABIgm4ypYkmgqVrcyZ6PjW99uPvyGsqF9UTcf9ZZnEmTqMsaQBYyyv4pNL1a9CUThuQ8Tgs3dKBfRZGL4qAgwRecwd+kV1o1OhcRignN1aizs5YwkcVglwoSwGTPK4/AEW2pdgwoASJCEkAwHqm+ZxYMts6yGpcodqcYUP1OQqvIX/ZnGFUA9ctlripc6BiHtHOzIc6WK5PX3xuS4JNbou92YwEKHkeQtiUM
          check:
            status: 204
      - name: Get valid license
        http:
          method: GET
          url: /v1/licensing/license
          auth:
            bearer:
              token: ${{ captures.token }}
          check:
            status: 200
            # NOTE: OpenAPI 3.1-style `type: [string, "null"]` not supported.
            # schema: { $ref: openapi.json#/components/schemas/LicenseDetails }
            jsonpath:
              $.name: Testing (test.local.)
              $.user_limit: 20
              $.expiry: null
              $.ttl_ms: null
      - http:
          method: GET
          url: /v1/licensing/status
          auth:
            bearer:
              token: ${{ captures.token }}
          check:
            status: 200
            # NOTE: OpenAPI 3.1-style `type: [string, "null"]` not supported.
            # schema: { $ref: openapi.json#/components/schemas/LicensingStatus }
            jsonpath:
              $.license.name: Testing (test.local.)
              $.user_count:
                - isNumber: true
                - gte: 0
              $.remaining_seats:
                - isNumber: true
                - gte: 0
      - name: Set old Community license
        http:
          method: PUT
          url: /v1/licensing/license
          auth:
            bearer:
              token: ${{ captures.token }}
          headers:
            Content-Type: text/plain
          # NOTE: Community license for v0.17.0.
          body: Eo4CCqEBCgRuYW1lChJDb21tdW5pdHkgKDAuMTcuMCkKCnVzZXJfbGltaXQKC2FwaV92ZXJzaW9uCgYwLjE3LjAKB2FsbG93ZWQYBiIKCggIgAgSAxiBCCIJCgcIgggSAhAUIg4KDAgEEgMYgwgSAxiECDIyCjAKAggbEgcIgwgSAggWEgwIBBIDGIMIEgMIhQgaEwoECgIIFgoFCgMIhQgKBBoCCBUSJAgAEiBCGY87LF7xJVeFhzTbxtnLxpWlpzvfH8+YB5zoHG4aohpAkrljPmYpuwdgn9b/dh6gTZSpyY6T975vj4LyFH7HtF+aZ0OeHfNNnrrfB6/3dGLL+VLhdS6TFu2eXoddilCwCigBIkISQPgoXb+l4RkcRfFFFEZdS+UfuWLMvyXG44cDtw8BCKQ6/P9vOIArvHfufB6pzMiylJ1TyhucQgv9std1NMjpUQ0=
          check:
            status: 400
            jsonpath:
              $.error: bad_request
              $.message: "Bad request: Invalid base64 license: Bad Pod API version."
      - name: Set invalid domain
        http:
          method: PUT
          url: /v1/licensing/license
          auth:
            bearer:
              token: ${{ captures.token }}
          headers:
            Content-Type: text/plain
          # NOTE: Testing license for `invalid.local`.
          body: EowCCp8BCgRuYW1lChhUZXN0aW5nIChpbnZhbGlkLmxvY2FsLikKCnVzZXJfbGltaXQKDmludmFsaWQubG9jYWwuCgdhbGxvd2VkGAYiCgoICIAIEgMYgQgiCQoHCIIIEgIQFCINCgsIBBICGBQSAxiDCDIwCi4KAggbEgYIFBICCBQSCwgEEgIYFBIDCIQIGhMKBAoCCBQKBQoDCIQICgQaAggVEiQIABIgJ6ZnIwhZc6Ei9r0W3dFt8m2jS+EXt3Lb+u49biZAYNsaQDOnbokwLmgjz83RaAv6IBvygRzPtxVYlm74YodCuspAtM9P5h7aMgpCZmO/NqgEwHr66C39Ji2rYhbqBPW5swIoASJCEkATauoN2e5i4nIRwh7Cg/iKwgoR+PXd7uJQG4Q4sbaufYXYhjK0vyCppIunJi5+bhzKUhKDbvESWRBKaIFdQcwE
          check:
            status: 400
            jsonpath:
              $.error: bad_request
              $.message: "Bad request: Invalid base64 license: Wrong domain."
