version: "1.1"
name: DNS setup
config:
  http:
    baseURL: ${{ env.host }}
env:
  $ref: "env.yaml#/env"

tests:
  proxyAnalyticsEvent:
    name: Proxy analytics event
    steps:
      - name: Check CORS
        http:
          method: OPTIONS
          url: /cloud-api-proxy/v1/analytics/event
          check:
            status: 200
      - name: Send event
        http:
          method: POST
          url: /cloud-api-proxy/v1/analytics/event
          json:
            name: "account:signin"
            data:
              credential_type: "password"
            origin:
              app:
                name: "prose-app-web"
                version: "1.0.1"
                platform: "macos-aarch64"
              pod:
                domain_hash: "f4ce232118cee9d2"
                user_hash: "19a124bd2f89edfe"
          check:
            status: 200
            headers:
              Content-Type: application/json
            # NOTE: We use an echo server instead of the Cloud API so we can
            #   assert what the Cloud API receives. This is not what the
            #   Cloud API will send in practice but it’s not what those tests
            #   are for (and the Pod API doesn’t care as it acts as a proxy).
            jsonpath:
              $.json.origin.pod.domain_hash: f4ce232118cee9d2
              $.json.origin.pod.user_hash:
                - isString: true
                - ne: 19a124bd2f89edfe
              $.json.origin.pod.user_count_range: "10–19"
  proxySoftwareUpdates:
    name: Proxy software updates
    steps:
      - name: Check CORS
        http:
          method: OPTIONS
          url: /prose-files-proxy/apps/updates/latest.json
          check:
            status: 200
      - name: Get updates manifest
        http:
          method: GET
          url: /prose-files-proxy/apps/updates/latest.json
          check:
            status: 200
      - name: Get one update
        http:
          method: GET
          url: /prose-files-proxy/apps/versions/0.14.1/macos/aarch64/update/Prose.app.tar.gz
          check:
            status: 200
