# TODO: When [zed-industries/zed#12999](https://github.com/zed-industries/zed/issues/12999) will be resolved,
#   move this in Zed's settings file (see <https://github.com/zed-industries/zed/issues/12999#issuecomment-2325061727>).
# yaml-language-server: $schema=https://raw.githubusercontent.com/stepci/stepci/main/schema.json

version: "1.1"
name: DNS routes
config:
  http:
    baseURL: ${{ env.host }}

# NOTE: `.` is not this file's path, it's the directory from which `stepci` is ran.
before:
  name: "Before all (not a test)"
  steps:
    - $ref: "init.yaml#/components/steps/init_server"
    - $ref: "init.yaml#/components/steps/create_first_admin"
    - $ref: "init.yaml#/components/steps/log_admin_in"

tests:
  dns:
    name: Check DNS records
    steps:
      - name: Configure the Pod's address
        http:
          method: PUT
          url: /v1/pod/config/address
          json:
            # ipv4: ${{ env.TESTING_POD_PUBLIC_IPV4 }}
            # ipv6: ${{ env.TESTING_POD_PUBLIC_IPV6 }}
            hostname: ${{ env.TESTING_POD_PUBLIC_HOSTNAME }}
          auth:
            bearer:
              token: ${{ captures.token }}
          check:
            status: 200
      - name: Run checks
        sse:
          url: ${{ env.host }}/v1/network/checks/dns
          check:
            messages:
              # - id: IPv4
              #   type: dns-record-check-result
              #   jsonpath:
              #     $.description: IPv4 record for ${{ env.TESTING_POD_PUBLIC_HOSTNAME }}
              #     $.status: CHECKING
              # - id: IPv6
              #   type: dns-record-check-result
              #   jsonpath:
              #     $.description: IPv6 record for ${{ env.TESTING_POD_PUBLIC_HOSTNAME }}
              #     $.status: CHECKING
              - id: SRV-c2s
                type: dns-record-check-result
                jsonpath:
                  $.description: SRV record for client-to-server connections
                  $.status: CHECKING
              - id: SRV-s2s
                type: dns-record-check-result
                jsonpath:
                  $.description: SRV record for server-to-server connections
                  $.status: CHECKING
              # - id: IPv4
              #   type: dns-record-check-result
              #   jsonpath:
              #     $.description: IPv4 record for ${{ env.TESTING_POD_PUBLIC_HOSTNAME }}
              #     $.status: VALID
              # - id: IPv6
              #   type: dns-record-check-result
              #   jsonpath:
              #     $.description: IPv6 record for ${{ env.TESTING_POD_PUBLIC_HOSTNAME }}
              #     $.status: VALID
              - id: SRV-c2s
                type: dns-record-check-result
                jsonpath:
                  $.description: SRV record for client-to-server connections
                  $.status: VALID
              - id: SRV-s2s
                type: dns-record-check-result
                jsonpath:
                  $.description: SRV record for server-to-server connections
                  $.status: VALID

env:
  mainAdminUsername: ${{ internet.userName | fake }}
  mainAdminPassword: ${{ internet.password | fake }}
  hostname: ${{ env.TESTING_POD_PUBLIC_HOSTNAME }}
