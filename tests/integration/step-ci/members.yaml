version: "1.1"
name: List members
config:
  http:
    baseURL: ${{ env.host }}
env:
  # TODO: Once [stepci/stepci#220](https://github.com/stepci/stepci/issues/220)
  #   is resolved, replace all `http://127.0.0.1:8000/api-docs` by
  #   `${{ env.host }}/api-docs`.
  host: http://127.0.0.1:8000
  mainAdminUsername: ${{ internet.userName | fake }}
  mainAdminPassword: ${{ internet.password | fake }}
  hostname: ${{ internet.domainName | fake }}

# NOTE: `.` is not this file's path, it's the directory from which `stepci` is ran.
# TODO: Once [stepci/stepci#220](https://github.com/stepci/stepci/issues/220)
#   is resolved, replace all `./tests/integration/step-ci` by `${{ env.STEPCI_DIR }}`.
before:
  name: "Before all (not a test)"
  steps:
    - $ref: "init.yaml#/components/steps/init_server"
    - $ref: "init.yaml#/components/steps/create_first_admin"
    - $ref: "init.yaml#/components/steps/log_admin_in"
    - $ref: "#/components/steps/add_member"
    - $ref: "#/components/steps/add_member"
    - $ref: "#/components/steps/add_member"
    - $ref: "#/components/steps/add_member"
    # - FIXME: Set some member's avatar and nickname and test it in the "Enrich members" route

tests:
  listMembersDefault:
    name: Default
    steps:
      - name: List members
        http:
          method: GET
          url: /v1/members
          auth:
            bearer:
              token: ${{ captures.token }}
          check:
            status: 200
            headers:
              $ref: "#/components/headers/paginated_json"
            schema:
              type: array
              items:
                $ref: http://127.0.0.1:8000/api-docs/openapi.json#/components/schemas/Member
            jsonpath:
              # 4 created members + main admin account
              $.length: 5
  listMembersPage2:
    name: Page 2
    steps:
      - name: List members
        http:
          method: GET
          url: /v1/members
          params:
            page_number: 2
            page_size: 2
          auth:
            bearer:
              token: ${{ captures.token }}
          check:
            status: 206
            headers:
              $ref: "#/components/headers/paginated_json"
            schema:
              type: array
              items:
                $ref: http://127.0.0.1:8000/api-docs/openapi.json#/components/schemas/Member
            jsonpath:
              $.length: 2
  enrichMembers:
    name: Enrich members list
    steps:
      - name: List members
        http:
          method: GET
          url: /v1/members
          params:
            page_number: 1
            page_size: 3
          auth:
            bearer:
              token: ${{ captures.token }}
          check:
            status: 206
          captures:
            # TODO: Once [stepci/stepci#226](https://github.com/stepci/stepci/issues/226) is resolved,
            #   Remove hard-coded captures and use this one instead.
            # allMembersJids:
            #   jsonpath: $[*].jid
            jid1:
              jsonpath: $[0].jid
            jid2:
              jsonpath: $[1].jid
            jid3:
              jsonpath: $[2].jid
      - name: Enrich members (list as individual "jids" query params)
        sse:
          # TODO: If [stepci/stepci#228](https://github.com/stepci/stepci/discussions/228) is accepted,
          #   and after it's resolved, remove `${{ env.host }}` and use the global config instead.
          url: ${{ env.host }}/v1/enrich-members?jids=${{ captures.jid1 }}&jids=${{ captures.jid2 }}&jids=${{ captures.jid3 }}
          timeout: 2000
          auth:
            bearer:
              token: ${{ captures.token }}
          check:
            messages:
              - id: ${{ captures.jid1 }}
                jsonpath:
                  $.nickname: null
                  $.avatar: null
              - id: ${{ captures.jid2 }}
                jsonpath:
                  $.nickname: null
                  $.avatar: null
              - id: ${{ captures.jid3 }}
                jsonpath:
                  $.nickname: null
                  $.avatar: null
      - name: Enrich members (list as individual "jids[]" query params)
        sse:
          # TODO: If [stepci/stepci#228](https://github.com/stepci/stepci/discussions/228) is accepted,
          #   and after it's resolved, remove `${{ env.host }}` and use the global config instead.
          url: ${{ env.host }}/v1/enrich-members?jids[]=${{ captures.jid1 }}&jids[]=${{ captures.jid2 }}&jids[]=${{ captures.jid3 }}
          timeout: 2000
          auth:
            bearer:
              token: ${{ captures.token }}
          check:
            messages:
              - id: ${{ captures.jid1 }}
                jsonpath:
                  $.nickname: null
                  $.avatar: null
              - id: ${{ captures.jid2 }}
                jsonpath:
                  $.nickname: null
                  $.avatar: null
              - id: ${{ captures.jid3 }}
                jsonpath:
                  $.nickname: null
                  $.avatar: null

components:
  steps:
    add_member:
      # NOTE: We used a config flag to auto-accept invitations,
      #   because otherwise we'd have no way to accept them.
      $ref: "invitations.yaml#/components/steps/invite_member"
  headers:
    paginated_json:
      Content-Type: application/json
      Pagination-Current-Page: /\d+/
      Pagination-Page-Size: /\d+/
      Pagination-Page-Count: /\d+/
      Pagination-Item-Count: /\d+/
